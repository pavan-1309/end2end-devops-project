name: Deploy Monitoring Stack

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  deploy-monitoring:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG }}
    
    - name: Install Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'
    
    - name: Create Namespaces
      run: |
        kubectl apply -f k8s/namespaces/
    
    - name: Deploy Prometheus Stack
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update
        
        helm upgrade --install prometheus-stack prometheus-community/kube-prometheus-stack \
          --namespace monitoring \
          --values k8s/helm/prometheus-values.yaml \
          --wait \
          --timeout 10m
    
    - name: Apply ServiceMonitors
      run: |
        kubectl apply -f k8s/monitoring/servicemonitor.yaml
    
    - name: Get Access URLs
      run: |
        echo "## ðŸ”— Access URLs" >> $GITHUB_STEP_SUMMARY
        echo "- **Prometheus**: \`kubectl port-forward -n monitoring svc/prometheus-stack-kube-prom-prometheus 9090:9090\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Grafana**: \`kubectl port-forward -n monitoring svc/prometheus-stack-grafana 3000:80\`" >> $GITHUB_STEP_SUMMARY
        echo "- **AlertManager**: \`kubectl port-forward -n monitoring svc/prometheus-stack-kube-prom-alertmanager 9093:9093\`" >> $GITHUB_STEP_SUMMARY