name: Microservices CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [user-service, product-service, api-gateway]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    
    - name: Build ${{ matrix.service }}
      run: |
        cd microservices/${{ matrix.service }}
        mvn clean compile
    
    - name: Test ${{ matrix.service }}
      run: |
        cd microservices/${{ matrix.service }}
        mvn test
    
    - name: Set up JDK 17 for SonarQube
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: SonarQube Scan
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      run: |
        cd microservices/${{ matrix.service }}
        mvn sonar:sonar -Dsonar.projectKey=${{ matrix.service }} -Dsonar.skip=false
    
    - name: Set up JDK 11 for build
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: OWASP Dependency Check
      run: |
        cd microservices/${{ matrix.service }}
        mvn org.owasp:dependency-check-maven:check
    
    - name: Package ${{ matrix.service }}
      run: |
        cd microservices/${{ matrix.service }}
        mvn package -DskipTests

  docker-build:
    needs: build-and-test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [user-service, product-service, api-gateway, frontend]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 11 (for Java services)
      if: matrix.service != 'frontend'
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Build JAR (for Java services)
      if: matrix.service != 'frontend'
      run: |
        cd microservices/${{ matrix.service }}
        mvn package -DskipTests
    
    - name: Log in to Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: microservices/${{ matrix.service }}
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:${{ github.sha }}
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  deploy-monitoring:
    needs: docker-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG }}
    
    - name: Install Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'
    
    - name: Deploy Monitoring Stack
      run: |
        chmod +x k8s/deploy-monitoring.sh
        ./k8s/deploy-monitoring.sh

  deploy-microservices:
    needs: [docker-build, deploy-monitoring]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG }}
    
    - name: Update image tags
      run: |
        sed -i "s|IMAGE_TAG|${{ github.sha }}|g" k8s/deployment.yaml
        sed -i "s|your-nexus-repo:8082|${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}|g" k8s/deployment.yaml
    
    - name: Deploy Microservices
      run: |
        chmod +x k8s/deploy-microservices.sh
        ./k8s/deploy-microservices.sh
    
    - name: Run Integration Tests
      run: |
        chmod +x ci-cd/integration-tests.sh
        ./ci-cd/integration-tests.sh
    
    - name: Send Email Notification
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ðŸš€ Deployment ${{ job.status }}: ${{ github.repository }}"
        to: ${{ secrets.EMAIL_TO }}
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          ## Deployment Status: ${{ job.status }}
          
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Workflow:** ${{ github.workflow }}
          **Run ID:** ${{ github.run_id }}
          
          **Services Deployed:**
          - User Service
          - Product Service  
          - API Gateway
          - Frontend
          
          **Monitoring Stack:** âœ… Active
          
          **View Details:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}