name: Microservices CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  actions: read

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ github.actor }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [user-service, product-service, api-gateway]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    
    - name: Build ${{ matrix.service }}
      run: |
        cd microservices/${{ matrix.service }}
        mvn clean compile
    
    - name: Test ${{ matrix.service }}
      run: |
        cd microservices/${{ matrix.service }}
        mvn test
    
    - name: Package ${{ matrix.service }}
      run: |
        cd microservices/${{ matrix.service }}
        mvn package -DskipTests
    
    - name: Upload JAR artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.service }}-jar
        path: microservices/${{ matrix.service }}/target/*.jar

  docker-build:
    needs: build-and-test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [user-service, product-service, api-gateway, frontend]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Download JAR artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts
    
    - name: Copy JARs to correct locations
      run: |
        mkdir -p microservices/user-service/target
        mkdir -p microservices/product-service/target
        mkdir -p microservices/api-gateway/target
        cp artifacts/user-service-jar/*.jar microservices/user-service/target/ || true
        cp artifacts/product-service-jar/*.jar microservices/product-service/target/ || true
        cp artifacts/api-gateway-jar/*.jar microservices/api-gateway/target/ || true
    
    - name: Set up JDK 11 (for Java services)
      if: matrix.service != 'frontend'
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Build JAR (for Java services)
      if: matrix.service != 'frontend'
      run: |
        cd microservices/${{ matrix.service }}
        mvn package -DskipTests
    
    - name: Build Docker image
      uses: docker/build-push-action@v4
      with:
        context: microservices/${{ matrix.service }}
        push: false
        tags: ${{ env.IMAGE_NAME }}/${{ matrix.service }}:${{ github.sha }}
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.IMAGE_NAME }}/${{ matrix.service }}:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: 'trivy-results.sarif'

  deploy-monitoring:
    needs: docker-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-south-1
    
    - name: Configure kubectl for EKS
      run: |
        aws eks update-kubeconfig --region ap-south-1 --name observability
        kubectl get nodes
    
    - name: Install Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'
    
    - name: Deploy Monitoring Stack
      run: |
        chmod +x k8s/deploy-monitoring.sh
        ./k8s/deploy-monitoring.sh

  deploy-microservices:
    needs: [docker-build, deploy-monitoring]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-south-1
    
    - name: Configure kubectl for EKS
      run: |
        aws eks update-kubeconfig --region ap-south-1 --name observability
        kubectl get nodes
    
    - name: Update image tags
      run: |
        sed -i "s|IMAGE_TAG|${{ github.sha }}|g" k8s/deployment.yaml
        sed -i "s|your-nexus-repo:8082|${{ env.IMAGE_NAME }}|g" k8s/deployment.yaml
    
    - name: Deploy Microservices
      run: |
        sed -i "s|IMAGE_TAG|${{ github.sha }}|g" k8s/deployment.yaml
        sed -i "s|your-nexus-repo:8082|${{ env.IMAGE_NAME }}|g" k8s/deployment.yaml
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl get pods
    
    - name: Run Integration Tests
      run: |
        # Download all artifacts first
        mkdir -p microservices/user-service/target
        mkdir -p microservices/product-service/target
        mkdir -p microservices/api-gateway/target
        
        chmod +x ci-cd/integration-tests.sh
        ./ci-cd/integration-tests.sh
    
    - name: Send Email Notification
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ðŸš€ Deployment ${{ job.status }}: ${{ github.repository }}"
        to: ${{ secrets.EMAIL_TO }}
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          ## Deployment Status: ${{ job.status }}
          
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Workflow:** ${{ github.workflow }}
          **Run ID:** ${{ github.run_id }}
          
          **Services Deployed:**
          - User Service
          - Product Service  
          - API Gateway
          - Frontend
          
          **Monitoring Stack:** âœ… Active
          
          **View Details:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}